\chapter{設計}
\label{chap:design}

本章では、AES67を用いたIPベースのオーディオ伝送をするアプリケーションの設計について述べる。

\section{アプリケーションの構成}

本研究で実験を行うために必要な、アプリケーションの機能は大きく分けて2つに分類できる。AES67オーディオストリームの送信と、受信を行うものだ。

\section{AES67オーディオストリーム送信機能}

AES67オーデイオストリームの送信機能について述べる。AES67オーディオストリームは、Real-time Transport Protocol (RTP)\cite{rfc3550}\cite{rfc3551}を用いて、UDPで伝送される。

\subsection{IPマルチキャスト送信}

はじめに、AES67オーディオストリーム送信機能のうち、IPマルチキャストによって送信する機能について述べる。マルチキャストを用いることで、同一のオーディオストリームを複数のクライアント（オーディオ機器）で受信することが可能になる。

マルチキャスト送信の利点は、オーディオストリームを受け取る機器が複数台におよぶ場合、一つのオーディオストリーム（パケット）を複数の機器で受け取れるようになる。その一方で、オーディオストリームを受け取る機器が1台のみの場合は当該するオーディオストリームを受け取る必要のないオーディオ機器にもパケットが送信されてしまい、マルチキャスト送信は欠点となる。

IPv4マルチキャストアドレスはRFC5771\cite{rfc5771}において、224.0.0.0/4\footnote{224.0.0.0から239.255.255.255までのアドレス。クラスDアドレスともよばれる。}のアドレス空間を用いると定められている。DanteのAES67モードで動作させるには239.69.0.0/16\footnote{239.69.0.0から239.69.255.255までのアドレス。}のアドレス空間を用いると定められているため、本実装では239.69.0.0/16のアドレス範囲を使うものとする。

\subsection{IPユニキャスト送信}

次に、AES67オーディオストリーム送信機能のうち、IPユニキャストによって送信する機能について述べる。ユニキャストでは、オーディオストリームを一つのクライアントに向けて伝送する。マルチキャストが1対多の伝送であるのに対し、ユニキャストは1対1の伝送となる。

ユニキャスト送信の利点は、オーディオストリームを受け取る機器が1台のみの場合、他のオーディオ機器やそれ以外のネットワーク機器にパケットが流れず、効率よく伝送を行うことができる。

本稿執筆現在、DanteのAES67モードはユニキャスト伝送をサポートしていないため、AES67規格をフルサポートしている機器同士の機能である。

\subsection{SAPパケットの送信}

AES67規格では、5つのネットワーク内において対応機器を検出する方法が定められている。

\begin{itemize}
  \item {Bonjour}
  \item {Session Announcement Protocol}
  \item {Axia Discovery Protocol}
  \item {Wheatstone WheatnetIP Discovery Protocol}
  \item {AMWA NMOS Discovery and Registration Specification}
\end{itemize}

そのうち、Session Announcement Protocol(SAP)を用いた機器検出方法は、DanteのAES67モードで唯一サポートされている方法であり、今回の実験においてもSAPを使用する。

\subsection{PCMオーディオの送信}

オーディオストリームの内容は、AES67規格に準拠したPCM 24bit/48kHzの1チャンネル（モノラル）オーディオを伝送する。あらかじめFFmpeg\footnote{\url{https://www.ffmpeg.org/}}に代表される動画・音声のエンコーダを用いて、WAVE形式などからPCMフォーマットのオーディオを生成したものをアプリケーションに入力する。

\section{AES67オーディオストリーム受信機能}

前述したAES67オーディオストリーム送信機能で、伝送されたオーディオストリームを受信するための受信機能について述べる。

\subsection{RTPパケットの受信}

UDPマルチキャストアドレスやユニキャストアドレスにおいてAES67オーディオストリーム伝送に用いるデフォルトのポート番号5004番で待ち受け、RTPパケットを受信する。

\subsection{PCMオーディオの保存}

RTPパケットに含まれるPCMオーディオを取り出し、保存する。

\section{まとめ}

本章では、実験で用いるPCM形式のオーディオをAES67オーディオストリームで送受信するアプリケーションについての設計を述べた。次章では、本章で設計したアプリケーションの実装を行う。
